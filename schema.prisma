// Pakoa V2 - MLM Telecom Sales Distribution Platform
// PostgreSQL + Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER & MLM TREE
// =============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String?  @unique
  name      String
  avatarUrl String?

  // Role-based access control
  role      UserRole @default(AGENT)

  // MLM Tree Structure (3-level deep referral)
  parentId  String?
  parent    User?    @relation("ReferralTree", fields: [parentId], references: [id])
  children  User[]   @relation("ReferralTree")

  // Activation status - unlocks at $15,000 revenue (Llave del Reino)
  isActive           Boolean  @default(false)
  activatedAt        DateTime?
  totalRevenue       Decimal  @default(0) @db.Decimal(12, 2)

  // Commission rates (stored for flexibility, defaults match business rules)
  personalCommissionRate Decimal @default(0.30) @db.Decimal(5, 4) // 30%

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sales                       Sale[]
  commissionsEarned           Commission[]       @relation("CommissionRecipient")
  achievements                UserAchievement[]
  campaigns                   Campaign[]
  llaveSnapshots              LlaveSnapshot[]    @relation("LlaveSnapshots")
  legacySnapshots             CommissionSnapshot[] @relation("LegacySnapshots")
  weeklyCommissionsReceived   WeeklyCommission[] @relation("WeeklyCommissionsReceived")
  weeklyCommissionsSourcing   WeeklyCommission[] @relation("WeeklyCommissionsSourcing")

  // Admin impersonation relations
  impersonationsAsAdmin       ImpersonationSession[] @relation("AdminImpersonations")
  impersonationsAsTarget      ImpersonationSession[] @relation("TargetImpersonations")

  @@index([parentId])
  @@index([isActive])
  @@index([totalRevenue])
  @@index([role])
}

enum UserRole {
  AGENT  // Regular sales agent
  ADMIN  // Platform administrator
}

// =============================================================================
// ADMIN IMPERSONATION
// =============================================================================
// Allows admins to view the platform as any user (read-only)
// All sessions are logged for audit purposes

model ImpersonationSession {
  id            String    @id @default(cuid())

  adminId       String
  admin         User      @relation("AdminImpersonations", fields: [adminId], references: [id])

  targetUserId  String
  targetUser    User      @relation("TargetImpersonations", fields: [targetUserId], references: [id])

  startedAt     DateTime  @default(now())
  endedAt       DateTime? // null if still active

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
}

// =============================================================================
// SALES
// =============================================================================

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  basePrice   Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]
}

model Sale {
  id        String   @id @default(cuid())

  // Sale details
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String?
  product   Product?  @relation(fields: [productId], references: [id])

  // Product info (can be set directly without Product relation)
  productType String?   // e.g., "Internet 100MB", "Paquete TV+Internet"
  amount      Decimal   @db.Decimal(12, 2)

  quantity  Int       @default(1)
  unitPrice Decimal?  @db.Decimal(10, 2)
  totalPrice Decimal? @db.Decimal(12, 2) // quantity * unitPrice (legacy)

  // Cycle reference for commission period
  cycleId   String?
  cycle     Cycle?    @relation(fields: [cycleId], references: [id])

  // Optional campaign attribution
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  // Customer info (the end buyer)
  customerName  String
  customerPhone String?
  customerEmail String?

  // Funnel status
  funnelStatus  FunnelStatus @default(PROSPECTO)

  // Funnel stage timestamps
  capturedAt    DateTime  @default(now()) // When lead was created
  quotedAt      DateTime? // When quote was sent
  scheduledAt   DateTime? // When installation was scheduled
  installedAt   DateTime? // When installed - this counts toward KPI
  cancelledAt   DateTime? // If cancelled

  notes         String?

  // Legacy status (kept for backward compatibility)
  status    SaleStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  commissions       Commission[]
  weeklyCommissions WeeklyCommission[]

  @@index([userId])
  @@index([cycleId])
  @@index([createdAt])
  @@index([status])
  @@index([funnelStatus])
  @@index([installedAt])
}

enum FunnelStatus {
  PROSPECTO   // Initial lead
  COTIZADO    // Quote sent
  AGENDADO    // Installation scheduled
  INSTALADO   // Installed - counts toward KPI
  CANCELADO   // Cancelled
}

enum SaleStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

// =============================================================================
// LLAVE DEL REINO (Weekly Threshold Snapshots)
// =============================================================================
// Threshold: $15,000 in rolling 30-day sales
// Evaluated every Wednesday at 00:00 CST (Mexico City)
// Must be re-earned weekly - dropping below loses Llave status

model LlaveSnapshot {
  id                String   @id @default(cuid())

  userId            String
  user              User     @relation("LlaveSnapshots", fields: [userId], references: [id])

  weekDate          DateTime // The Wednesday date of evaluation
  rolling30DaySales Decimal  @db.Decimal(12, 2) // Sales amount at snapshot time
  hasLlave          Boolean  // Was >= $15,000 at snapshot time

  createdAt         DateTime @default(now())

  @@unique([userId, weekDate])
  @@index([userId])
  @@index([weekDate])
  @@index([hasLlave])
}

// =============================================================================
// WEEKLY COMMISSIONS (Chain-based Commission Tracking)
// =============================================================================
// Commissions are calculated weekly based on Llave status
// Chain rule: Every person in path must have Llave for commission to flow
// Max 3 generations: Hijo (8%), Nieto (12%), Bisnieto (20%)

model WeeklyCommission {
  id               String   @id @default(cuid())

  recipientId      String
  recipient        User     @relation("WeeklyCommissionsReceived", fields: [recipientId], references: [id])

  sourceAgentId    String
  sourceAgent      User     @relation("WeeklyCommissionsSourcing", fields: [sourceAgentId], references: [id])

  saleId           String
  sale             Sale     @relation(fields: [saleId], references: [id])

  weekDate         DateTime // The Wednesday of the commission week
  relationship     RelationshipType // hijo, nieto, bisnieto
  saleAmount       Decimal  @db.Decimal(12, 2)
  commissionRate   Decimal  @db.Decimal(5, 4) // 0.08, 0.12, or 0.20
  commissionAmount Decimal  @db.Decimal(12, 2)
  chainValid       Boolean  // Was the chain unbroken at calculation time

  createdAt        DateTime @default(now())

  @@index([recipientId])
  @@index([sourceAgentId])
  @@index([weekDate])
  @@index([chainValid])
}

enum RelationshipType {
  HIJO      // Level 1 - 8%
  NIETO     // Level 2 - 12%
  BISNIETO  // Level 3 - 20%
}

// Legacy model - kept for backward compatibility
model CommissionSnapshot {
  id               String   @id @default(cuid())

  userId           String
  user             User     @relation("LegacySnapshots", fields: [userId], references: [id])

  weekStartDate    DateTime // The Wednesday when snapshot was taken
  rolling30DaySales Decimal @db.Decimal(12, 2) // Sales amount at time of snapshot
  isActive         Boolean  // Was >= $1000 at snapshot time
  commissionEarned Decimal  @db.Decimal(12, 2) @default(0)

  createdAt        DateTime @default(now())

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
  @@index([isActive])
}

// =============================================================================
// COMMISSIONS
// =============================================================================

model Commission {
  id        String   @id @default(cuid())

  // Who receives the commission
  userId    String
  user      User     @relation("CommissionRecipient", fields: [userId], references: [id])

  // Source sale
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id])

  // Commission details
  type      CommissionType
  level     Int?     // null for PERSONAL, 1-3 for tree commissions
  rate      Decimal  @db.Decimal(5, 4) // The rate applied (e.g., 0.30, 0.08, 0.12, 0.20)
  amount    Decimal  @db.Decimal(12, 2)

  // Payment tracking
  cycleId   String
  cycle     Cycle    @relation(fields: [cycleId], references: [id])
  status    CommissionStatus @default(PENDING)
  paidAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([cycleId])
  @@index([status])
}

enum CommissionType {
  PERSONAL   // 30% - direct sale commission
  LEVEL_1    // 8% - first level referral
  LEVEL_2    // 12% - second level referral
  LEVEL_3    // 20% - third level referral
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// =============================================================================
// CAMPAIGNS (Budget System)
// =============================================================================

model Campaign {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  name      String

  // Budget calculation: revenue / 2.5, clamped to [$200, $800]
  // Renews weekly
  totalBudget    Decimal  @db.Decimal(10, 2)
  spentBudget    Decimal  @default(0) @db.Decimal(10, 2)
  remainingBudget Decimal @db.Decimal(10, 2) // Computed: totalBudget - spentBudget

  // Weekly renewal tracking
  weekStartDate  DateTime
  weekEndDate    DateTime

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@index([userId])
  @@index([weekStartDate, weekEndDate])
  @@index([isActive])
}

// =============================================================================
// CYCLES (Commission Payment Periods)
// =============================================================================

model Cycle {
  id        String   @id @default(cuid())

  name      String   // e.g., "2024-W01", "January 2024 Week 1"

  startDate DateTime
  endDate   DateTime

  status    CycleStatus @default(OPEN)

  // Aggregate stats (denormalized for performance)
  totalSales       Decimal @default(0) @db.Decimal(14, 2)
  totalCommissions Decimal @default(0) @db.Decimal(14, 2)

  closedAt  DateTime?
  paidAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales       Sale[]
  commissions Commission[]

  @@unique([startDate, endDate])
  @@index([status])
}

enum CycleStatus {
  OPEN       // Accepting sales
  CLOSED     // Sales finalized, calculating commissions
  PROCESSING // Commissions being paid
  COMPLETED  // All paid out
}

// =============================================================================
// ACHIEVEMENTS (Gamification)
// =============================================================================

model Achievement {
  id          String   @id @default(cuid())

  code        String   @unique // e.g., "FIRST_SALE", "ACTIVATE", "10K_REVENUE"
  name        String
  description String
  iconUrl     String?

  // Achievement criteria (stored as JSON for flexibility)
  criteria    Json     // e.g., {"type": "revenue", "threshold": 1000}

  // Reward (optional)
  rewardType   AchievementRewardType?
  rewardValue  Decimal? @db.Decimal(10, 2)

  // Display order
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users UserAchievement[]
}

model UserAchievement {
  id            String   @id @default(cuid())

  userId        String
  user          User        @relation(fields: [userId], references: [id])
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  earnedAt      DateTime @default(now())

  // Progress tracking (for progressive achievements)
  progress      Decimal? @db.Decimal(10, 2)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([earnedAt])
}

enum AchievementRewardType {
  BONUS_COMMISSION
  BUDGET_BOOST
  BADGE_ONLY
}

// =============================================================================
// BUSINESS RULES REFERENCE (Documented in Schema)
// =============================================================================
//
// MLM TREE STRUCTURE:
// - Maximum 3 levels deep commission scope (NEVER beyond bisnietos)
// - User.parentId creates the tree relationship
//
// LLAVE DEL REINO (Key to the Kingdom):
// - Threshold: $15,000 in rolling 30-day sales
// - Evaluated every Wednesday at 00:00 CST (Mexico City timezone)
// - Status is binary: Active (has Llave) or Inactive
// - Must be re-earned every week
//
// COMMISSION RATES (Tree Commissions Only):
// - Hijo (Level 1): 8%
// - Nieto (Level 2): 12%
// - Bisnieto (Level 3): 20%
// - Tataranieto (Level 4+): 0% ALWAYS - no exceptions
//
// THE CHAIN RULE:
// - Commissions only flow through UNBROKEN chains
// - Every person in the path must have Llave active
// - Example: You → Hijo → Nieto → Bisnieto
//   - Hijo's sales → 8% (if You have Llave)
//   - Nieto's sales → 12% (if You + Hijo have Llave)
//   - Bisnieto's sales → 20% (if You + Hijo + Nieto have Llave)
//
// CAMPAIGN BUDGET:
// - Formula: revenue / 2.5
// - Minimum: $200
// - Maximum: $800
// - Renews weekly (tracked via weekStartDate/weekEndDate)
//
// =============================================================================
